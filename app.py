import streamlit as st
import requests
from collections import Counter

# --------------------
# í˜ì´ì§€ ì„¤ì •
# --------------------
st.set_page_config(
    page_title="ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?",
    page_icon="ğŸ¬",
    layout="wide"
)

# --------------------
# ì‚¬ì´ë“œë°” - TMDB API Key ì…ë ¥
# --------------------
st.sidebar.title("ğŸ”‘ TMDB ì„¤ì •")
tmdb_api_key = st.sidebar.text_input(
    "TMDB API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”",
    type="password"
)

# --------------------
# ì œëª© & ì†Œê°œ
# --------------------
st.title("ğŸ¬ ë‚˜ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?")
st.write("ê°„ë‹¨í•œ ì‹¬ë¦¬í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë‹¹ì‹ ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ì˜í™” ì¥ë¥´ì™€ ì‘í’ˆì„ ì¶”ì²œí•´ë“œë ¤ìš” ğŸ¿")

st.divider()

# --------------------
# ì§ˆë¬¸ ë°ì´í„°
# --------------------
questions = [
    {
        "question": "Q1. ì‹œí—˜ ëë‚œ ë‚ , ê°‘ìê¸° í•˜ë£¨ê°€ í†µì§¸ë¡œ ë¹„ì—ˆë‹¤! ê°€ì¥ ëŒë¦¬ëŠ” ê³„íšì€?",
        "options": [
            "ì¡°ìš©í•œ ì¹´í˜ì—ì„œ ìŒì•… ë“¤ìœ¼ë©° í•˜ë£¨ ì •ë¦¬í•˜ê¸° â˜•",
            "ì¹œêµ¬ë“¤ì´ë‘ ì¦‰í¥ ì—¬í–‰ ë– ë‚˜ê¸° ğŸš—",
            "ì§‘ì—ì„œ ì„¸ê³„ê´€ ëª°ì…ë˜ëŠ” ì½˜í…ì¸  ì •ì£¼í–‰ ğŸª",
            "ì•„ë¬´ ìƒê° ì—†ì´ ì›ƒê¸´ ì˜ìƒë§Œ ê³„ì† ë³´ê¸° ğŸ˜‚"
        ]
    },
    {
        "question": "Q2. ìƒˆë²½ 2ì‹œ, ê´œíˆ ê°ì„± í­ë°œí•  ë•Œ ë“œëŠ” ìƒê°ì€?",
        "options": [
            "ì‚¬ëŒ ê´€ê³„ëŠ” ì™œ ì´ë ‡ê²Œ ë³µì¡í• ê¹Œâ€¦",
            "ì§€ê¸ˆ ë‹¹ì¥ ì–´ë””ë¡ ê°€ ë– ë‚˜ê³  ì‹¶ë‹¤",
            "ë§Œì•½ ë‹¤ë¥¸ ì°¨ì›ì˜ ë‚´ê°€ ìˆë‹¤ë©´?",
            "ì´ ì‹œê°„ì— ë‚˜ë§Œ ì´ëŸ¬ëŠ” ê±° ì•„ë‹˜?"
        ]
    },
    {
        "question": "Q3. ì¹œêµ¬ê°€ ê°™ì´ ì˜í™” ë³´ìê³  í•œë‹¤. ë„¤ê°€ ê³ ë¥´ëŠ” ì¥ë¥´ëŠ”?",
        "options": [
            "ì—¬ìš´ ë‚¨ëŠ” ìŠ¤í† ë¦¬ ì¤‘ì‹¬ ì˜í™” ğŸ",
            "ìŠ¤ì¼€ì¼ í° ì¥ë©´ ë§ì€ ì˜í™” ğŸ’¥",
            "ìƒìƒë ¥ í„°ì§€ëŠ” ì„¸ê³„ê´€ ì˜í™” âœ¨",
            "ë°°ê¼½ ì¡ê³  ì›ƒì„ ìˆ˜ ìˆëŠ” ì˜í™” ğŸ¤£"
        ]
    },
    {
        "question": "Q4. ê³¼ì œê°€ ë„ˆë¬´ ë§ì•„ ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì„ ë•Œ, ë„ˆì˜ íšŒë³µ ë°©ì‹ì€?",
        "options": [
            "í˜¼ì ì¡°ìš©íˆ ìƒê° ì •ë¦¬í•˜ë©° ê°ì • ì†Œí™”í•˜ê¸°",
            "ìš´ë™í•˜ê±°ë‚˜ ë°–ì—ì„œ í™œë™í•˜ë©° ìŠ¤íŠ¸ë ˆìŠ¤ ë‚ ë¦¬ê¸°",
            "í˜„ì‹¤ ìŠê³  ë‹¤ë¥¸ ì„¸ê³„ë¡œ ë„í”¼í•˜ê¸°",
            "ì¹œêµ¬ë“¤ì´ë‘ ìˆ˜ë‹¤ ë–¨ë©° ì›ƒì–´ë²„ë¦¬ê¸°"
        ]
    },
    {
        "question": "Q5. ë„¤ ì¸ìƒì„ ì˜í™” í•œ í¸ìœ¼ë¡œ ë§Œë“ ë‹¤ë©´?",
        "options": [
            "ê°ì •ì„ ì´ ì¤‘ìš”í•œ ì„±ì¥ ì´ì•¼ê¸° ğŸŒ±",
            "ìœ„ê¸°ë¥¼ ê·¹ë³µí•˜ëŠ” ë„ì „ì˜ ì—°ì† ğŸ”¥",
            "í‰ë²”í•´ ë³´ì´ì§€ë§Œ ë¹„ë°€ì´ ìˆ¨ê²¨ì§„ ì„¸ê³„ ğŸŒŒ",
            "ì‚¬ê±´ì€ ë§ì€ë° ê³„ì† ì›ƒí”ˆ ì „ê°œ ğŸ¤ª"
        ]
    }
]

# --------------------
# ì¥ë¥´ ë§¤í•‘
# --------------------
genre_map = {
    "ë¡œë§¨ìŠ¤/ë“œë¼ë§ˆ": {
        "ids": [18, 10749],
        "reason": "ê°ì •ê³¼ ê´€ê³„, ìŠ¤í† ë¦¬ì— ê¹Šì´ ê³µê°í•˜ëŠ” íƒ€ì…ì´ì—ìš”."
    },
    "ì•¡ì…˜/ì–´ë“œë²¤ì²˜": {
        "ids": [28],
        "reason": "ë„ì „ê³¼ ìŠ¤ë¦´, ì—­ë™ì ì¸ ì „ê°œë¥¼ ì¦ê¸°ëŠ” íƒ€ì…ì´ì—ìš”."
    },
    "SF/íŒíƒ€ì§€": {
        "ids": [878, 14],
        "reason": "ìƒìƒë ¥ ë„˜ì¹˜ëŠ” ì„¸ê³„ê´€ê³¼ ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì— ëŒë¦¬ëŠ” íƒ€ì…ì´ì—ìš”."
    },
    "ì½”ë¯¸ë””": {
        "ids": [35],
        "reason": "ì›ƒìŒê³¼ ê°€ë²¼ìš´ ë¶„ìœ„ê¸°ë¡œ ì—ë„ˆì§€ë¥¼ ì–»ëŠ” íƒ€ì…ì´ì—ìš”."
    }
}

genre_keys = list(genre_map.keys())

# --------------------
# ì§ˆë¬¸ í‘œì‹œ
# --------------------
answers = []

for idx, q in enumerate(questions):
    choice = st.radio(
        q["question"],
        q["options"],
        key=f"q{idx}"
    )
    answers.append(q["options"].index(choice))
    st.write("")

st.divider()

# --------------------
# ê²°ê³¼ ë²„íŠ¼
# --------------------
if st.button("ğŸ¯ ê²°ê³¼ ë³´ê¸°"):
    if not tmdb_api_key:
        st.error("TMDB API Keyë¥¼ ì‚¬ì´ë“œë°”ì— ì…ë ¥í•´ì£¼ì„¸ìš”!")
    else:
        st.subheader("ğŸ” ë¶„ì„ ì¤‘...")
        st.write("ë‹¹ì‹ ì˜ ì„ íƒì„ ë°”íƒ•ìœ¼ë¡œ ì˜í™”ë¥¼ ì¶”ì²œí•˜ê³  ìˆì–´ìš” ğŸ¬")

        # --------------------
        # 1ï¸âƒ£ ì¥ë¥´ ë¶„ì„
        # --------------------
        counter = Counter(answers)
        top_choice = counter.most_common(1)[0][0]
        selected_genre = genre_keys[top_choice]

        st.success(f"âœ¨ ë‹¹ì‹ ì—ê²Œ ì–´ìš¸ë¦¬ëŠ” ì¥ë¥´: **{selected_genre}**")
        st.write(genre_map[selected_genre]["reason"])

        # --------------------
        # 2ï¸âƒ£ TMDB API í˜¸ì¶œ
        # --------------------
        genre_ids = ",".join(map(str, genre_map[selected_genre]["ids"]))

        url = (
            "https://api.themoviedb.org/3/discover/movie"
            f"?api_key={tmdb_api_key}"
            f"&with_genres={genre_ids}"
            "&language=ko-KR"
            "&sort_by=popularity.desc"
        )

        response = requests.get(url)
        data = response.json()

        st.divider()
        st.subheader("ğŸ¬ ì¶”ì²œ ì˜í™” TOP 5")

        # --------------------
        # 3ï¸âƒ£ ì˜í™” í‘œì‹œ
        # --------------------
        for movie in data.get("results", [])[:5]:
            col1, col2 = st.columns([1, 3])

            with col1:
                if movie.get("poster_path"):
                    poster_url = "https://image.tmdb.org/t/p/w500" + movie["poster_path"]
                    st.image(poster_url, use_container_width=True)
                else:
                    st.write("í¬ìŠ¤í„° ì—†ìŒ")

            with col2:
                st.markdown(f"### {movie['title']}")
                st.write(f"â­ í‰ì : {movie['vote_average']}")
                st.write(movie.get("overview", "ì¤„ê±°ë¦¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."))
                st.caption("ğŸ’¡ ì´ ì˜í™”ë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ : ë‹¹ì‹ ì˜ ì„ íƒì´ ì´ ì˜í™”ì˜ ë¶„ìœ„ê¸°ì™€ ì˜ ì–´ìš¸ë ¤ìš”.")

            st.divider()

